# 0x03 处理机调度

## 处理机调度的层次

调度的实质是一种资源分配，处理机调度是对处理机资源进行分配。

### 高级调度（长程调度/作业调度）

- **调度对象是作业。**

- 主要功能：决定在外存的后备队列中的哪几个作业调度到内存中，并为其创建进程，分配必要的资源，然后将其放到就绪队列。
- 主要用于多道批处理系统，在分时系统和实时系统中不设置

### 低级调度（短程调度/进程调度）

- **调度的对象是进程**
- 主要功能：根据某种算法，决定就绪队列中的哪个进程应该获得处理机，并由分派程序将处理机分配给选中的进程
- 最基本的调度算法，多道批处理，分时和实时中都存在

### 中级调度（内存调度）

- **目的**
  - 提高内存利用率和系统吞吐量
- **对象是处于挂起状态的进程**
- 当已经具有运行条件并内存有稍有空闲时，由中级调度来决定，把外存上那些已经具备运行条件的就绪进程再重新调入内存，并改为就绪态，挂到就绪队列中
- 实际上是存储器管理中的对换功能

## 调度算法的评价指标

### CPU利用率

$$
CPU的利用率=\frac {CPU有效工作时间} {CPU有效工作时间+CPU空闲时间}
$$

### 系统吞吐量

单位时间内完成作业的数量
$$
系统吞吐量=\frac {完成作业的数量}{完成作业所花费的时间}
$$

### 周转时间

从作业提交给系统开始，到作业完成为止的这段时间间隔，它包括4个部分的时间

- 在后备队列中等待作业调度的时间
- 在就绪队列中等待进程调度的时间
- 进程在CPU上执行的时间
- 进程等待I/O操作完成的时间

$$
周转时间= 作业完成时间-作业提交时间
$$

$$
平均周转时间 = \frac{各个作业的周转时间之和}{作业数}
$$

$$
带权周转时间 = \frac{作业周转时间}{作业实际运行时间}
$$

$$
平均带权周转时间 = \frac{各作业带权周转时间之和}{作业数}
$$

### 等待时间

- 进程
  - 进程建立后等待被服务的时间之和，等待I/O完成的期间其实进程也是在被服务 的，所以不计入等待时间
- 作业
  - 进程建立后的等待时间以及作业在外存后备队列中的等待时间

### 响应时间

- 用户从提出请求到首次产生响应所需要的时间

## 调度算法

### 先来先服务（FCFS）

- 按照进程在就绪队列中到达的先后顺序进行服务，先到达先服务，后到达后服务
- 可用于进程调度，也可用于作业调度
- 非抢占式
- 不会引起饥饿

### 短作业优先算法

- 在就绪队列优先最短的作业调入到CPU中
- 可用于进程调度，也可用于作业调度
- 都可
  - 非抢占式
  - 抢占式（最短剩余时间优先算法）
    - 当有新进程加入就绪队列中，就看它是否抢占CPU，如果它的服务时间比当前进程的剩余时间短，则抢占
- 会引起饥饿，如果有源源不断的短作业到来，就会引起长作业饥饿

### 高响应比优先算法

- 每次选择最高响应比的进程进入CPU
  $$
  响应比=\frac{等待时间+要求服务时间}{要求服务时间}
  $$
  根据上式，相应比 >= 1

- 可用于进程调度，也可用于作业调度

- 非抢占式，即进程主动放弃CPU才能进行调度

- 等待时间相同，短作业优先

  服务时间相同，长作业优先

- 不会饥饿



以上三种都不关心响应时间，对于用户的交互相应很差，适用于早期批处理系统。

以下三种适用于交互系统

### 时间片轮转算法

- 按照先后到达的顺序，轮流让进程执行一个时间片
- 进程调度
- 抢占式，由时钟中断来通知CPU使用时间已到
- 缺点
  - 如果时间片太大，就变成了先来先服务
  - 如果时间片太小，就会引起进程的频繁切换，开销太大
- 优点：适用于分时系统
- 不会引起饥饿

### 优先级调度算法

- 高优先级的优先调度
- 可用于进程调度，也可用于作业调度
- 都可
  - 非抢占式
  - 抢占式
- 适用于实时系统
- 会引起饥饿，如果有源源不断的高优先作业到来，就会引起低优先级作业饥饿

### 多级反馈队列调度算法

![](https://raw.githubusercontent.com/yxcoder1997/PictureBed/master/img/20200729131938.png)

- 算法流程
  - 设置n个队列，由高到低优先级降低，时间片增大，每个队列采用FCFS原则进行时间片轮转
  - 如果时间片完，进程没有结束，则进入下一个队列
  - 当第i级队列为空时，第i+1级队列才开始进行时间片轮转，如果此时第i级队列到达一个新进程，则第i+1级正在进行的进程被剥夺，并回到原（第i+1级）队列的队尾
  - 如果在最后一级，也是回到最后一级的队尾
- 进程调度
- 抢占式
- 会引起饥饿，如果有源源不断的短作业到来，而会在第1级队列种完成，就会引起低级队列的饥饿